#TB_TOP := tb
#TB_TOP := tb_regfile
#TB_TOP := tb_alu
#TB_TOP := tb_alurv
#TB_TOP := tb_control
TB_TOP := tb_rv64i
#TB_TOP := tb_rv64i_readgpioid
#TB_TOP := tb_rv64i_filldmem

SOURCES_SV := \
	../src/as_pack.sv \
	../../RV_NoPipeline/src/asRegFile.sv \
	../../RV_NoPipeline/src/asAdd.sv \
	../../RV_NoPipeline/src/asDMemBack.sv \
	../../RV_NoPipeline/src/asDMemFront.sv \
	../../RV_NoPipeline/src/asDMemCore.sv \
	../../RV_NoPipeline/src/asDMem.sv \
	../../RV_NoPipeline/src/asIMem.sv \
	../../RV_NoPipeline/src/asImmGen.sv \
	../../RV_NoPipeline/src/asMux2.sv \
	../../RV_NoPipeline/src/asMux3.sv \
	../src/asPC.sv \
	../../RV_NoPipeline/src/asAluRV.sv \
	../../RV_NoPipeline/src/asControlAll.sv \
	../../../ip_jtag/src/tap_fsm.sv \
	../../../ip_jtag/src/ir_cell.sv \
	../../../ip_jtag/src/dr_cell.sv \
	../../../ip_jtag/src/scan_cell.sv \
	../../../ip_jtag/src/by_cell.sv \
	../../../ip_jtag/src/ir_reg.sv \
	../../../ip_jtag/src/dr_reg.sv \
	../../../ip_jtag/src/ir_decode.sv \
	../../../ip_jtag/src/jtag.sv \
	../../RV_NoPipeline/src/asMBpi.sv \
	../../RV_NoPipeline/src/asSBpi.sv \
	../../RV_NoPipeline/src/asGpio.sv \
	../../RV_NoPipeline/src/asGpioTop.sv \
	../src/stage01Fetch.sv \
	../src/stage02Decode.sv \
	../src/stage03Execute.sv \
	../src/stage05WriteBack.sv \
	../src/dataHazardDetect.sv \
	../src/dataHazardForwardDetect.sv \
	../src/asCPU.sv \
	../../RV_NoPipeline/src/asDecode.sv \
	../../RV_NoPipeline/src/asCguCore.sv \
	../../RV_NoPipeline/src/asCgu.sv \
	../src/asTopMem.sv \
	../tb/tb_rv64i.sv

#	../src/asDelReg.sv \
#../../RV_NoPipeline/src/asSBpiMem.sv \

COMP_OPTS_SV := \
	--incr \
	--relax \

DEFINES_SV := -d LOGIC_SV

#target_name : dependency_1 dependency_2 dependency_3
#    bash_command_that_generates_the_target <parameters>

#ifeq (xxx,yyy)
#<-SPACES-> $(info "some text")
#endif

#first_target : some_dependency
#<-TAB-> some_bash_command
#<-TAB-> another_bash_command

#another_target : first_target some_other_dependency
#<-TAB-> yet_another_bash_command

#==== Default target - running simulation without drawing waveforms ====#
.PHONY : simulate
simulate : $(TB_TOP)_snapshot.wdb

.PHONY : elaborate
elaborate : .elab.timestamp

.PHONY : compile
compile : .comp_sv.timestamp

#==== WAVEFORM DRAWING ====#
.phony: waves
waves : $(TB_TOP)_snapshot.wdb
	@echo
	@echo "### OPENING WAVES ###"
	xsim --gui $(TB_TOP)_snapshot.wdb --tclbatch ./xsim_cfg2.tcl

#==== SIMULATION ====#
$(TB_TOP)_snapshot.wdb : .elab.timestamp
	@echo
	@echo "### RUNNING SIMULATION ###"
#	xsim $(TB_TOP)_snapshot --tclbatch ./xsim_cfg.tcl
	xsim --gui $(TB_TOP)_snapshot --tclbatch ./xsim_cfg2.tcl

#==== ELABORATION ====#
.elab.timestamp : .comp_sv.timestamp
	@echo
	@echo "### ELABORATING ###"
	xelab -debug all -top $(TB_TOP) -snapshot $(TB_TOP)_snapshot
	touch .elab.timestamp

#==== COMPILING SYSTEMVERILOG ====#
.comp_sv.timestamp : $(SOURCES_SV)
	@echo
	@echo "### COMPILING SYSTEMVERILOG ###"
	xvlog --sv $(COMP_OPTS_SV) $(DEFINES_SV) $(SOURCES_SV)
	cp -rf riscvtest_$(TB_TOP).mem riscvtest.mem
	touch .comp_sv.timestamp

.phony : clean
clean :
	rm -rf *.jou *.log *.pb *.wdb xsim.dir      # This deletes all files generated by Vivado
	rm -rf .*.timestamp                         # This deletes all our timestamps
	rm -rf vivado_pid*

.phony : activate
activate :
	source /tools/Xilinx/Vivado/2024.2/settings64.sh
